name: Build Apex Linux ISO

on:
  workflow_dispatch:
    inputs:
      release_ver:
        description: 'Fedora Release Version'
        required: true
        default: '43'
        type: string
      kickstart_path:
        description: 'Path to kickstart file'
        required: true
        default: 'iso/kickstarts/apex-kde.ks'
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container:
      image: fedora:${{ inputs.release_ver }}
      options: --privileged

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: dnf install -y lorax lorax-lmc-novirt anaconda pykickstart git wget zstd

      - name: Lint Kickstart Syntax
        run: ksvalidator "${{ inputs.kickstart_path }}"


      - name: Generate Date Variable
        run: echo "DATE=$(date +%F)" >> $GITHUB_ENV

      - name: Build Apex Linux ISO
        run: |
          git config --global --add safe.directory "*"
          rm -rf ./Results
          
          livemedia-creator \
            --ks "${{ inputs.kickstart_path }}" \
            --no-virt \
            --make-iso \
            --iso-only \
            --project "Apex Linux" \
            --volid "Apex-KDE-${{ inputs.release_ver }}" \
            --iso-name "Apex-Linux-KDE-${{ inputs.release_ver }}-$(date +%Y%m%d).iso" \
            --releasever "${{ inputs.release_ver }}" \
            --resultdir ./Results

      - name: Verify ISO Size
        run: |
          echo "Checking ISO size..."
          ls -lh ./Results/*.iso
          du -h ./Results/*.iso

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: Daily-Build-${{ github.run_number }}
          name: Apex Linux Build ${{ github.run_number }}
          body: |
            ### Apex Linux Daily Build
            - **Base:** Fedora ${{ inputs.release_ver }}
            - **Desktop:** KDE Plasma Minimal
            - **Date:** ${{ env.DATE }} 
          files: ./Results/*.iso
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # === DEBUGGING ===
      - name: "DEBUG: Print program.log"
        if: failure() && hashFiles('./program.log') != ''
        run: cat ./program.log

      - name: "DEBUG: Print livemedia.log"
        if: failure() && hashFiles('./livemedia.log') != ''
        run: cat ./livemedia.log
