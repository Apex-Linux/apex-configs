name: Build Apex Linux ISO

on:
  workflow_dispatch:
    inputs:
      release_ver:
        description: 'Apex Release Version'
        required: true
        default: '43'
        type: string
      kickstart_path:
        description: 'Path to kickstart file'
        required: true
        default: 'iso/kickstarts/apex-kde.ks'
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container:
      image: fedora:${{ inputs.release_ver }}
      options: --privileged

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: dnf install -y lorax lorax-lmc-novirt anaconda pykickstart git wget zstd xz dbus-daemon util-linux

      - name: Lint Kickstart Syntax
        run: ksvalidator "${{ inputs.kickstart_path }}"

      - name: Generate Date Variable
        run: echo "DATE=$(date +%F)" >> $GITHUB_ENV

      - name: ðŸ”§ Fix DBus & Machine ID
        run: |
          dbus-uuidgen > /var/lib/dbus/machine-id
          mkdir -p /var/run/dbus
          dbus-daemon --system --fork
          echo "âœ… DBus System Bus is now running."

      - name: Build Apex Linux ISO
        run: |
          git config --global --add safe.directory "*"
          rm -rf ./Results
          
          # BUILD COMMAND
          livemedia-creator \
            --ks "${{ inputs.kickstart_path }}" \
            --no-virt \
            --make-iso \
            --iso-only \
            --compression xz \
            --project "Apex Linux" \
            --volid "Apex-KDE-${{ inputs.release_ver }}" \
            --iso-name "Apex-Linux-KDE-${{ inputs.release_ver }}-$(date +%Y%m%d).iso" \
            --releasever "${{ inputs.release_ver }}" \
            --resultdir ./Results

      - name: âš–ï¸ Check & Split ISO (Bypass GitHub Limit)
        run: |
          cd ./Results
          ISO_FILE=$(ls *.iso | head -n 1)
          FILE_SIZE=$(stat -c%s "$ISO_FILE")
          LIMIT=2100000000 # 2.1 GB Limit

          echo "File size is: $FILE_SIZE bytes"

          if [ $FILE_SIZE -ge $LIMIT ]; then
            echo "âš ï¸ ISO is too big for a single upload!"
            echo "âœ‚ï¸ Splitting into 2GB chunks..."
            # Split into parts named .iso.000, .iso.001, etc.
            split -b 2000M -d "$ISO_FILE" "$ISO_FILE."
            
            # Remove the original big file so we don't try to upload it
            rm "$ISO_FILE"
            echo "âœ… Split complete."
          else
            echo "âœ… ISO is safe for single upload."
          fi

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v2026.1.${{ github.run_number }}
          name: Apex Linux ${{ env.DATE }}
          body: |
            ## Apex Linux 2026.1
            **The Full KDE Experience.**
            
            - **Version:** Build ${{ github.run_number }}
            - **Base:** Fedora ${{ inputs.release_ver }}
            
            ### âš ï¸ Download Instructions (If Split)
            If you see files named `.iso.00`, `.iso.01`:
            1. Download all parts.
            2. **Windows:** Use 7-Zip to extract the first file (`.00`), it will combine them automatically.
            3. **Linux/Mac:** Run `cat *.iso.* > Apex-Linux.iso`
          files: ./Results/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "DEBUG: Print logs"
        if: failure()
        run: |
          [ -f ./program.log ] && cat ./program.log
          [ -f ./livemedia.log ] && cat ./livemedia.log
