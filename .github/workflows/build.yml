name: Build Apex Linux ISO

on:
  workflow_dispatch:
    inputs:
      release_ver:
        description: 'Apex Release Version'
        required: true
        default: '43'
        type: string
      kickstart_path:
        description: 'Path to kickstart file'
        required: true
        default: 'iso/kickstarts/apex-kde.ks'
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container:
      image: fedora:${{ inputs.release_ver }}
      options: --privileged

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        # Added 'pykickstart' for ksflatten and 'git' for asset injection
        run: dnf install -y lorax lorax-lmc-novirt anaconda pykickstart git wget zstd xz dbus-daemon util-linux

      - name: Lint Kickstart Syntax
        run: ksvalidator "${{ inputs.kickstart_path }}"

      - name: Generate Date Variable
        run: echo "DATE=$(date +%Y%m%d)" >> $GITHUB_ENV

      - name: ðŸ”§ Fix DBus & Machine ID
        run: |
          dbus-uuidgen > /var/lib/dbus/machine-id
          mkdir -p /var/run/dbus
          dbus-daemon --system --fork
          echo "âœ… DBus System Bus is now running."

      - name: ðŸ”¨ Flatten Kickstart
        run: |
          echo "Merging kickstart files..."
          # Fix for 'git clone' inside kickstarts if used
          git config --global --add safe.directory "*"
          ksflatten -c "${{ inputs.kickstart_path }}" -o flattened-kickstart.ks
          echo "âœ… Flattening complete."

      - name: Build Apex Linux ISO
        run: |
          rm -rf ./Results
          
          livemedia-creator \
            --ks flattened-kickstart.ks \
            --no-virt \
            --make-iso \
            --iso-only \
            --compression xz \
            --project "Apex Linux" \
            --volid "Apex-KDE-${{ inputs.release_ver }}" \
            --iso-name "Apex-Linux-KDE-${{ inputs.release_ver }}-${{ env.DATE }}.iso" \
            --releasever "${{ inputs.release_ver }}" \
            --resultdir ./Results

      - name: âš–ï¸ Check & Split ISO (Strict 1.9GB Limit)
        run: |
          cd ./Results
          ISO_FILE=$(ls *.iso | head -n 1)
          FILE_SIZE=$(stat -c%s "$ISO_FILE")
          LIMIT=1900000000 # 1.9GB

          echo "File size: $FILE_SIZE"
          if [ $FILE_SIZE -ge $LIMIT ]; then
            echo "âš ï¸ ISO > 1.9 GB. Splitting..."
            split -b 1900M -d "$ISO_FILE" "$ISO_FILE."
            rm "$ISO_FILE"
            echo "âœ… Split complete."
          else
            echo "âœ… ISO is safe for single upload."
          fi

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v2026.1.${{ github.run_number }}
          name: Apex Linux ${{ env.DATE }}
          body: |
            ## Apex Linux 2026.1 (Build ${{ github.run_number }})
            **The Modern Fedora 43 Experience.**
            
            - **Base:** Fedora ${{ inputs.release_ver }}
            - **Kernel:** Latest
            - **Desktop:** KDE Plasma 6
            
            ### âš ï¸ Installation
            If you see files ending in `.iso.00`, `.iso.01`:
            1. Download all parts.
            2. **Windows:** Extract `.00` with 7-Zip.
            3. **Linux:** `cat *.iso.* > Apex-Linux.iso`
          files: ./Results/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
