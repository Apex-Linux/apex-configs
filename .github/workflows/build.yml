name: Build Apex Linux ISO

on:
  workflow_dispatch:
    inputs:
      release_ver:
        description: 'Apex Release Version'
        required: true
        default: '43'
        type: string
      kickstart_path:
        description: 'Path to kickstart file'
        required: true
        default: 'iso/kickstarts/apex-kde.ks'
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container:
      image: fedora:${{ inputs.release_ver }}
      options: --privileged

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        # Added 'xz' explicitly to ensure high-compression tools are available
        run: dnf install -y lorax lorax-lmc-novirt anaconda pykickstart git wget zstd xz

      - name: Lint Kickstart Syntax
        run: ksvalidator "${{ inputs.kickstart_path }}"

      - name: Generate Date Variable
        run: echo "DATE=$(date +%F)" >> $GITHUB_ENV

      - name: Build Apex Linux ISO
        run: |
          git config --global --add safe.directory "*"
          rm -rf ./Results
          
          # SAFETY FIX: Added '--compression xz'
          # This forces High Compression to keep the ISO under the 2GB GitHub Limit.
          livemedia-creator \
            --ks "${{ inputs.kickstart_path }}" \
            --no-virt \
            --make-iso \
            --iso-only \
            --compression xz \
            --project "Apex Linux" \
            --volid "Apex-KDE-${{ inputs.release_ver }}" \
            --iso-name "Apex-Linux-KDE-${{ inputs.release_ver }}-$(date +%Y%m%d).iso" \
            --releasever "${{ inputs.release_ver }}" \
            --resultdir ./Results

      - name: Verify ISO Size
        run: |
          echo "Checking ISO size..."
          ls -lh ./Results/*.iso
          du -h ./Results/*.iso

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v2026.1.${{ github.run_number }}
          name: Apex Linux ${{ env.DATE }}
          body: |
            ## Apex Linux
            **The Minimal KDE Experience.**
            
            - **Version:** 2026.1 (Build ${{ github.run_number }})
            - **Base:** Fedora ${{ inputs.release_ver }} (Bleeding Edge)
            - **Desktop:** KDE Plasma 6
            - **Kernel:** Latest 6.x
            
            *Clean. Fast. Apex.*
          files: ./Results/*.iso
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "DEBUG: Print program.log"
        if: failure() && hashFiles('./program.log') != ''
        run: cat ./program.log

      - name: "DEBUG: Print livemedia.log"
        if: failure() && hashFiles('./livemedia.log') != ''
        run: cat ./livemedia.log
